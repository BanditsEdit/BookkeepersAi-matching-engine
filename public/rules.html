<script>
  const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('authorization='));
  let clientId = null;

  if (!tokenCookie) {
    window.location.href = `/login.html?redirect=rules`;
  } else {
    const token = tokenCookie.split('=')[1];

    // üîë Get client info first
    async function getClientInfo() {
      const res = await fetch('/me', {
        headers: { 'Authorization': token }
      });

      if (!res.ok) {
        alert("Session expired or access denied.");
        window.location.href = `/login.html?redirect=rules`;
        return;
      }

      const data = await res.json();
      clientId = data.client_id;
    }

    // üì• Load all rules for this client
    async function loadRules() {
      const res = await fetch('/rules', {
        headers: { 'Authorization': token }
      });

      if (!res.ok) {
        alert("Failed to fetch rules.");
        return;
      }

      const data = (await res.json()).data || [];
      const tbody = document.querySelector('#rulesTable tbody');
      tbody.innerHTML = '';

      data.forEach(rule => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${rule.rule_name}</td>
          <td>${rule.vendor_keyword}</td>
          <td>¬£${rule.amount_range.min} - ¬£${rule.amount_range.max}</td>
          <td>${rule.account_code}</td>
          <td>${rule.vat_code}</td>
          <td><button onclick="deleteRule('${rule.id}')">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // üö™ Logout function
    function logout() {
      document.cookie = 'authorization=; Max-Age=0';
      window.location.href = 'https://bookkeppersai.banditsaimarketing.com';
    }

    // üöÄ Main App Logic
    (async () => {
      await getClientInfo(); // Get client_id securely
      await loadRules();     // Load rules only after auth

      // üìù Form submission handler
      document.getElementById('ruleForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;

        const payload = {
          client_id: clientId,
          rule_name: form.rule_name.value,
          vendor_keyword: form.vendor_keyword.value,
          amount_range: {
            min: parseFloat(form.min_amount.value),
            max: parseFloat(form.max_amount.value)
          },
          account_code: form.account_code.value,
          vat_code: form.vat_code.value,
          is_active: true
        };

        const res = await fetch('/rules', {
          method: 'POST',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          form.reset();
          await loadRules();
          alert("Rule added successfully!");
        } else {
          const error = await res.json();
          alert("Failed to add rule: " + (error.message || 'Unknown error'));
        }
      });
    })();
  }
</script>