<script>
  const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('authorization='));
  let clientId = null;

  if (!tokenCookie) {
    window.location.href = `/login.html?redirect=rules`;
  } else {
    const token = tokenCookie.split('=')[1];

    // ğŸ”‘ Get client info BEFORE anything else
    async function getClientInfo() {
      const res = await fetch('/me', {
        headers: { 'Authorization': token }
      });

      if (!res.ok) {
        alert("Session expired or access denied.");
        window.location.href = `/login.html?redirect=rules`;
        return;
      }

      const data = await res.json();
      clientId = data.client_id;
    }

    // ğŸ“¥ Load Rules Table
    async function loadRules() {
      const res = await fetch('/rules', {
        headers: { 'Authorization': token }
      });

      if (!res.ok) {
        alert("Failed to fetch rules. Your session may have expired.");
        window.location.href = `/login.html?redirect=rules`;
        return;
      }

      const data = (await res.json()).data || [];
      const tbody = document.querySelector('#rulesTable tbody');
      tbody.innerHTML = '';

      data.forEach(rule => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${rule.rule_name}</td>
          <td>${rule.vendor_keyword}</td>
          <td>Â£${rule.amount_range.min} - Â£${rule.amount_range.max}</td>
          <td>${rule.account_code}</td>
          <td>${rule.vat_code}</td>
          <td><button onclick="deleteRule('${rule.id}')">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // ğŸ” Logout
    function logout() {
      document.cookie = 'authorization=; Max-Age=0';
      window.location.href = 'https://bookkeppersai.banditsaimarketing.com';
    }

    // ğŸ§  MAIN FLOW
    (async () => {
      await getClientInfo(); // ğŸ‘ˆ Needed before submit logic
      await loadRules();     // ğŸ‘ˆ Only load once client is verified

      // ğŸ“ FORM SUBMIT
      document.getElementById('ruleForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;

        const payload = {
          client_id: clientId, // âœ… Comes from outer scope
          rule_name: form.rule_name.value,
          vendor_keyword: form.vendor_keyword.value,
          amount_range: {
            min: parseFloat(form.min_amount.value),
            max: parseFloat(form.max_amount.value)
          },
          account_code: form.account_code.value,
          vat_code: form.vat_code.value,
          is_active: true
        };

        const res = await fetch('/rules', {
          method: 'POST',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          form.reset();
          await loadRules(); // Refresh rules table
          alert("Rule added successfully!");
        } else {
          const error = await res.json();
          alert("Failed to add rule: " + (error.message || 'Unknown error'));
        }
      });
    })(); // ğŸ‘ˆ Immediately invoked async wrapper
  }
</script>
